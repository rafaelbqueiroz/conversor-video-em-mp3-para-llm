<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extrator de √Åudio - V√≠deo para MP3</title>
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>Extrator de √Åudio - V√≠deo para MP3</h1>
        <div class="info-box">
            <p>Formatos suportados: .ts, .mp4, .avi, .mkv, .mov, .wmv, .flv, .webm, .m4v, .mpg, .mpeg, .3gp, .3g2</p>
            <p>Qualidade do √°udio: MP3 192kbps</p>
        </div>

        <form id="uploadForm">
            <div class="upload-area" id="drop-zone">
                <input type="file" id="fileInput" accept=".ts,.mp4,.avi,.mkv,.mov,.wmv,.flv,.webm,.m4v,.mpg,.mpeg,.3gp,.3g2" required>
                <label for="fileInput" class="file-label">
                    <div class="upload-icon">üìÅ</div>
                    Arraste um arquivo de v√≠deo aqui<br>
                    ou clique para selecionar
                </label>
            </div>
            <button type="submit" id="uploadButton">Extrair √Åudio (MP3)</button>
        </form>

        <div id="progress-container" style="display: none;">
            <div class="progress-bar">
                <div id="progress" class="progress-fill"></div>
            </div>
            <p class="progress-text">Progresso: <span id="progress-value">0</span>%</p>
            <p id="status-message"></p>
        </div>

        <div id="download-container" style="display: none;">
            <a id="download-link" class="download-button">
                <span class="download-icon">‚¨áÔ∏è</span> Baixar MP3
            </a>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const form = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress');
        const progressValue = document.getElementById('progress-value');
        const statusMessage = document.getElementById('status-message');
        const downloadContainer = document.getElementById('download-container');
        const downloadLink = document.getElementById('download-link');
        const dropZone = document.getElementById('drop-zone');

        form.onsubmit = async (e) => {
            e.preventDefault();
            
            const file = fileInput.files[0];
            if (!file) {
                alert('Por favor, selecione um arquivo de v√≠deo');
                return;
            }

            // Mostrar container de progresso
            progressContainer.style.display = 'block';
            downloadContainer.style.display = 'none';
            statusMessage.textContent = 'Enviando arquivo...';
            
            const formData = new FormData();
            formData.append('video', file);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                const data = await response.json();
                statusMessage.textContent = 'Extraindo √°udio...';
                
                socket.emit('subscribeToConversion', data.id);
            } catch (error) {
                statusMessage.textContent = 'Erro: ' + error.message;
                console.error('Erro:', error);
            }
        };

        // Drag and drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults (e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropZone.classList.add('highlight');
        }

        function unhighlight(e) {
            dropZone.classList.remove('highlight');
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            fileInput.files = dt.files;
            
            // Verificar extens√£o do arquivo
            const ext = file.name.split('.').pop().toLowerCase();
            const validExtensions = ['ts', 'mp4', 'avi', 'mkv', 'mov', 'wmv', 'flv', 'webm', 'm4v', 'mpg', 'mpeg', '3gp', '3g2'];
            
            if (validExtensions.includes(ext)) {
                form.requestSubmit();
            } else {
                alert('Formato de arquivo n√£o suportado. Por favor, use um dos formatos aceitos.');
            }
        }

        // Socket.IO event handlers
        socket.on('conversionProgress', (data) => {
            progressBar.style.width = data.progress + '%';
            progressValue.textContent = Math.round(data.progress);
        });

        socket.on('conversionComplete', (data) => {
            statusMessage.textContent = 'Extra√ß√£o de √°udio conclu√≠da!';
            downloadContainer.style.display = 'block';
            downloadLink.href = data.downloadUrl;
            downloadLink.download = data.filename;
        });

        socket.on('conversionError', (error) => {
            statusMessage.textContent = 'Erro na convers√£o: ' + error.message;
        });
    </script>
</body>
</html>